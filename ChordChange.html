<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chord Change Practicer</title>
<style>
html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; }
body { background:black; color:white; font-family:Arial,sans-serif; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; }
#controls { display:flex; flex-wrap:wrap; align-items:center; margin:10px; }
button { margin:2px; padding:10px; background:#282828; color:white; border:none; cursor:pointer; }
button.active { background:red; }
#beat { color:lime; }
#note { color:cyan; }
#nextChord { color:orange; margin-left:20px; }
#keys, #accidentals, #cycleButtons { display:flex; flex-wrap:wrap; margin:5px; }
select { margin-left:10px; padding:5px; background:#282828; color:white; border:none; }
.chord-count { margin-right:20px; } /* space between chord count and sound selector */
</style>
</head>
<body>

<h1 id="title">Chord Change Practicer</h1>

<div id="controls">
    BPM: <input type="range" id="bpmSlider" min="30" max="180" value="100">
    <span id="bpmLabel">100</span>
    <button id="startStop">Start</button>
    <button id="repeatBtn">Repeat Off</button>
    <button id="resetCount">Reset Count</button>
    Chord Changes: <span id="chordCount" class="chord-count">0</span>
    Click Sound:
    <select id="wavSelector"></select>
</div>

<div>
    <span id="note">-</span>
    <span id="nextChord">-</span>
</div>

<div id="beat">‚óè</div>

<div id="keys">
    Key:
    <button data-key="C">C</button>
    <button data-key="D">D</button>
    <button data-key="E">E</button>
    <button data-key="F">F</button>
    <button data-key="G">G</button>
    <button data-key="A">A</button>
    <button data-key="B">B</button>
</div>

<div id="accidentals">
    <button data-acc="#">#</button>
    <button data-acc="b">b</button>
</div>

<div id="cycleButtons">
    Chord Cycle:
    <button data-cycle="2">2</button>
    <button data-cycle="3">3</button>
    <button data-cycle="4" class="active">4</button>
    <button data-cycle="6">6</button>
    <button data-cycle="8">8</button>
</div>

<audio id="clickSound"></audio>

<script>
// --- WAV Files ---
const clickSoundElement = document.getElementById('clickSound');
const wavSelector = document.getElementById('wavSelector');
const wavFiles = Array.from({length: 120}, (_, i) => `${i+1}.wav`);
wavFiles.forEach(file => {
    const opt = document.createElement('option');
    opt.value = `wav/${file}`;
    opt.textContent = file;
    wavSelector.appendChild(opt);
});
clickSoundElement.src = wavSelector.value;
wavSelector.addEventListener('change', ()=>{ clickSoundElement.src = wavSelector.value; });

// --- Metronome ---
let bpm=100, isRunning=false, repeatMode=false, chordCycle=4, cyclePos=0;
let chordCount=parseInt(localStorage.getItem('chordCount'))||0;
let currentKey="C", currentAccidental="", notes=[], nextChord="-";
let repeatChords=[], repeatIndex=0, timer=null;

const bpmSlider = document.getElementById('bpmSlider');
const bpmLabel = document.getElementById('bpmLabel');
const startStop = document.getElementById('startStop');
const repeatBtn = document.getElementById('repeatBtn');
const resetCount = document.getElementById('resetCount');
const noteLabel = document.getElementById('note');
const nextChordLabel = document.getElementById('nextChord');
const beatLabel = document.getElementById('beat');
const chordCountLabel = document.getElementById('chordCount');
const keys = document.querySelectorAll('#keys button');
const accidentals = document.querySelectorAll('#accidentals button');
const cycleButtons = document.querySelectorAll('#cycleButtons button');
const title = document.getElementById('title');

// --- Notes Map ---
function applyAccidental(key, accidental){
    const noteOrder=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const flatMap={"Db":"C#","Eb":"D#","Gb":"F#","Ab":"G#","Bb":"A#"};
    let index=noteOrder.indexOf(key); if(index===-1) index=noteOrder.indexOf(flatMap[key])||0;
    if(accidental==="#") index=(index+1)%noteOrder.length;
    if(accidental==="b") index=(index-1+noteOrder.length)%noteOrder.length;
    let newKey=noteOrder[index];
    switch(newKey){
        case "C": return ["C","Dm","Em","F","G","Am"];
        case "C#": return ["C#","D#m","E#m","F#","G#","A#m"];
        case "Db": return ["Db","Ebm","Fm","Gb","Ab","Bbm"];
        case "D": return ["D","Em","F#m","G","A","Bm"];
        case "D#": return ["D#","E#m","Gm","G#","A#","B#m"];
        case "Eb": return ["Eb","Fm","Gm","Ab","Bb","Cm"];
        case "E": return ["E","F#m","G#m","A","B","C#m"];
        case "F": return ["F","Gm","Am","Bb","C","Dm"];
        case "F#": return ["F#","G#m","A#m","B","C#","D#m"];
        case "Gb": return ["Gb","Abm","Bbm","Cb","Db","Ebm"];
        case "G": return ["G","Am","Bm","C","D","Em"];
        case "G#": return ["G#","A#m","B#m","C#","D#","E#m"];
        case "Ab": return ["Ab","Bbm","Cm","Db","Eb","Fm"];
        case "A": return ["A","Bm","C#m","D","E","F#m"];
        case "A#": return ["A#","Bm","Cm","D#","F","Gm"];
        case "Bb": return ["Bb","Cm","Dm","Eb","F","Gm"];
        case "B": return ["B","C#m","D#m","E","F#","G#m"];
        default: return ["C","Dm","Em","F","G","Am"];
    }
}

// --- Timer ---
function startTimer(){
    clearInterval(timer);
    const interval = 60000 / bpm;
    timer = setInterval(()=>{
        // --- Set beat color BEFORE increment ---
        if(cyclePos === 0){
            beatLabel.style.color = "lime"; // first beat of cycle
        } else {
            beatLabel.style.color = (cyclePos % 2 === 1) ? "red" : "yellow";
        }

        // Play click sound
        clickSoundElement.currentTime = 0; 
        clickSoundElement.play();

        // Advance cycle
        cyclePos++;

        if(cyclePos >= chordCycle){
            cyclePos = 0;
            // Apply chord change
            noteLabel.textContent = nextChord;

            if(repeatMode){
                repeatIndex = (repeatIndex + 1) % repeatChords.length;
                nextChord = repeatChords[repeatIndex];
            } else {
                nextChord = notes[Math.floor(Math.random() * notes.length)];
            }

            nextChordLabel.textContent = nextChord;

            chordCount++; 
            chordCountLabel.textContent = chordCount;
            localStorage.setItem('chordCount', chordCount);
        }
    }, interval);
}

// --- Event Listeners ---
bpmSlider.addEventListener('input', ()=>{ bpm=parseInt(bpmSlider.value); bpmLabel.textContent=bpm; if(isRunning) startTimer(); });
startStop.addEventListener('click', ()=>{
    if(isRunning){ clearInterval(timer); isRunning=false; startStop.textContent="Start"; }
    else{ cyclePos=0; startTimer(); isRunning=true; startStop.textContent="Stop"; }
});
repeatBtn.addEventListener('click', ()=>{
    repeatMode=!repeatMode;
    if(repeatMode){ repeatBtn.textContent="Repeat On"; repeatBtn.classList.add("active"); repeatChords=Array.from({length:4},()=>notes[Math.floor(Math.random()*notes.length)]); repeatIndex=0; nextChord=repeatChords[0]; }
    else{ repeatBtn.textContent="Repeat Off"; repeatBtn.classList.remove("active"); nextChord=notes[Math.floor(Math.random()*notes.length)]; }
    nextChordLabel.textContent=nextChord;
});
resetCount.addEventListener('click', ()=>{ chordCount=0; chordCountLabel.textContent=chordCount; localStorage.setItem('chordCount',chordCount); });
keys.forEach(btn=>btn.addEventListener('click', ()=>{ currentKey=btn.dataset.key; notes=applyAccidental(currentKey,currentAccidental); nextChord=notes[Math.floor(Math.random()*notes.length)]; nextChordLabel.textContent=nextChord; }));
accidentals.forEach(btn=>btn.addEventListener('click', ()=>{ let acc=btn.dataset.acc; currentAccidental=(currentAccidental===acc)?"":acc; notes=applyAccidental(currentKey,currentAccidental); nextChord=notes[Math.floor(Math.random()*notes.length)]; nextChordLabel.textContent=nextChord; }));
cycleButtons.forEach(btn=>btn.addEventListener('click', ()=>{ chordCycle=parseInt(btn.dataset.cycle); cyclePos=0; cycleButtons.forEach(b=>b.classList.remove("active")); btn.classList.add("active"); }));

// --- Scaling ---
function scaleUI(){
    const widthScale = window.innerWidth/1050;
    const heightScale = window.innerHeight/700;
    const scale = Math.min(widthScale,heightScale);
    noteLabel.style.fontSize = `${150*scale}px`;
    nextChordLabel.style.fontSize = `${100*scale}px`;
    beatLabel.style.fontSize = `${60*scale}px`;
    title.style.fontSize = `${32*scale}px`;
    keys.forEach(b=>{ b.style.width=`${70*scale}px`; b.style.height=`${40*scale}px`; });
    accidentals.forEach(b=>{ b.style.width=`${50*scale}px`; b.style.height=`${40*scale}px`; });
    cycleButtons.forEach(b=>{ b.style.width=`${50*scale}px`; b.style.height=`${40*scale}px`; });
}
window.addEventListener('resize', scaleUI);
scaleUI();

// --- Init ---
notes=applyAccidental(currentKey,currentAccidental);
nextChord=notes[Math.floor(Math.random()*notes.length)];
noteLabel.textContent="-";
nextChordLabel.textContent=nextChord;
chordCountLabel.textContent=chordCount;
bpmLabel.textContent=bpm;

</script>
</body>
</html>
